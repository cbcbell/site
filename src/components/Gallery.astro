---
import type { ImageMetadata } from "astro"
import { Image } from "astro:assets"
import exifr from "exifr"
import { join } from "node:path"
import "@fancyapps/ui/dist/fancybox/fancybox.css"

type Props = {
  galleryFolder: string
  title: string
  cover?: ImageMetadata
}

const { galleryFolder, title, cover } = Astro.props

const imageModules = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/sync/**/*.{jpg,jpeg,png}",
  { eager: true },
)

const decodeUtf8 = (value?: unknown) =>
  typeof value === "string"
    ? Buffer.from(value, "latin1").toString("utf8")
    : value

const galleryImages = await Promise.all(
  Object.entries(imageModules)
    .filter(([path]) => path.includes(`/${galleryFolder}/`))
    .sort(([pathA], [pathB]) => pathA.localeCompare(pathB))
    .map(async ([path, mod]) => {
      // const filename = path.split("/").pop() || title

      let caption: string | undefined
      let year: string | undefined
      try {
        const filePath = join(process.cwd(), "src/components", path)
        const exif = await exifr.parse(filePath, { iptc: true })
        caption = exif?.ImageDescription || exif?.Description
        year = decodeUtf8(exif?.Sublocation ?? "")?.replace("-", "â€“")
      } catch {
        caption = undefined
      }
      const alt = caption?.includes(". ") ? caption.split(". ")[0] : title

      return {
        src: mod.default,
        width: mod.default.width,
        height: mod.default.height,
        alt,
        caption,
        year,
      }
    }),
)
---

<section
  class="mt-8 grid gap-4 sm:grid-cols-2 md:grid-cols-3 md:gap-6 lg:grid-cols-4"
  id="fancybox"
>
  {
    galleryImages.map((image, i) => (
      <a
        style={`--width: ${image.width}; --height: ${image.height};`}
        href={image.src.src}
        target="_blank"
        data-fancybox="gallery"
        data-caption={image.caption}
        data-year={image.year}
      >
        <Image
          src={image.src}
          alt={image.alt}
          class="aspect-square h-full w-full object-cover"
          loading={i < 8 ? "eager" : "lazy"}
          sizes="(min-width: 1024px) 25vw, (min-width: 768px) 33vw, 50vw"
        />
      </a>
    ))
  }
</section>

<style>
  #fancybox a {
    display: flex;
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  #fancybox a::after {
    content: attr(data-year);
  }
</style>
<script>
  import { Fancybox } from "@fancyapps/ui/dist/fancybox/"

  Fancybox.bind("[data-fancybox]", {
    theme: "auto",
    mainStyle: {
      "--f-button-width": "44px",
      "--f-button-height": "44px",
      "--f-button-border-radius": "50%",
      "--f-toolbar-padding": "16px",
      "--f-toolbar-gap": "8px",
    },
    Carousel: {
      Arrows: true,
      Thumbs: {
        showOnStart: false,
      },
      Toolbar: {
        display: {
          left: [],
          middle: [],
          right: ["toggleFull", "thumbs", "close"],
        },
      },
      transition: "slide",
    },
  })
</script>
